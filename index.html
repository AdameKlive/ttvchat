<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Local Twitch Message Creator</title>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
body { margin:0; font-family:Inter,sans-serif; background:#0e0e10; color:white; }
.container { max-width:1400px; margin:20px auto; display:flex; gap:20px; flex-wrap:wrap; justify-content:flex-start; }
.control-column { width:320px; display:flex; flex-direction:column; gap:20px; padding:20px; background:transparent; border-radius:12px; }
.controls-block { display:flex; flex-direction:column; gap:12px; background:rgba(24,24,27,0.8); padding:15px; border-radius:10px; }
.controls-block h3 { margin:0 0 10px 0; color:#fff; font-size:16px; font-weight:600; text-align:left; }
.grid-select { display:grid; grid-template-columns: repeat(6,1fr); gap:10px; max-height:220px; overflow-y:auto; padding:8px; border:1px solid #333; border-radius:6px; background:rgba(18,18,20,0.7); }
.color-swatch { width:28px; height:28px; border-radius:50%; cursor:pointer; border:2px solid transparent; transition: all 0.2s; }
.color-swatch.selected { border-color:#9147ff; }
.color-swatch:hover { opacity:0.8; }
.active-emblem-item { width:28px; height:28px; object-fit:contain; cursor:pointer; border:2px solid transparent; border-radius:4px; transition: all 0.2s; }
.active-emblem-item.active { border-color:#00ff00; }
.active-emblem-item:hover { opacity:0.8; }
input, textarea { width:100%; padding:10px; border-radius:6px; border:1px solid #444; background:#000; color:white; box-sizing:border-box; resize:none; }
input:focus, textarea:focus { border-color:#9147ff; outline:none; }
button { padding:10px 12px; border:none; border-radius:8px; font-weight:600; cursor:pointer; width:100%; }
button#save-comment { background:#9147ff; color:#fff; }
button.bg-btn { border:1px solid #333; background:#333; color:white; }
button.bg-btn.selected { border-color:#9147ff; background:#5a3d90; }
.bottom-preview-container { width:100%; display:flex; flex-direction:column; align-items:center; margin-top:30px; gap:10px; }
.chat-line { max-width:480px; padding:10px 15px; border-radius:8px; background:#000; font-size:16px; display:inline-block; text-align:left; overflow-wrap:break-word; transition: background 0.2s,color 0.2s; }
.chat-line.light-bg { background:#fff; color:#000; }
.chat-line.light-bg .message { color:#000; }
.badges { display:inline-flex; align-items:center; gap:2px; margin-right:5px; }
.badge { width:18px; height:18px; object-fit:contain; }
.chat-emote { width:24px; height:24px; vertical-align:middle; object-fit:contain; cursor:pointer; }
.username { font-weight:700; display:inline-flex; align-items:center; line-height:18px; vertical-align:middle; }
.message { word-break:break-word; display:inline; }
#message-controls-block { background-color:transparent; padding:0; }
#emotesSidebar { width:240px; display:flex; flex-direction:column; gap:10px; }
#emotesGridContainer { display:grid; grid-template-columns: repeat(6,1fr); gap:6px; max-height:500px; overflow-y:auto; background:rgba(18,18,20,0.7); border-radius:6px; padding:6px; }
</style>
</head>
<body>

<div class="container">

<div class="control-column">
<div class="controls-block">
<h3>Emblems Base</h3>
<div id="limitMessage"></div>
<div class="grid-select" id="emblemGrid"></div>
</div>

<div class="controls-block">
<h3>Username Colors</h3>
<div class="grid-select" style="grid-template-columns:repeat(4,1fr);">
<div class="color-swatch" style="background-color:#ff0000" data-color="#ff0000"></div>
<div class="color-swatch" style="background-color:#00ff00" data-color="#00ff00"></div>
<div class="color-swatch" style="background-color:#0000ff" data-color="#0000ff"></div>
<div class="color-swatch" style="background-color:#ff8c00" data-color="#ff8c00"></div>
<div class="color-swatch" style="background-color:#ffd700" data-color="#ffd700"></div>
<div class="color-swatch" style="background-color:#1eff00" data-color="#1eff00"></div>
<div class="color-swatch" style="background-color:#00ffcc" data-color="#00ffcc"></div>
<div class="color-swatch" style="background-color:#f06400" data-color="#f06400"></div>
<div class="color-swatch" style="background-color:#ff69b4" data-color="#ff69b4"></div>
<div class="color-swatch" style="background-color:#9147ff" data-color="#9147ff"></div>
<div class="color-swatch" style="background-color:#00ccff" data-color="#00ccff"></div>
<div class="color-swatch" style="background-color:#ff4500" data-color="#ff4500"></div>
</div>

<h3>Message Background</h3>
<div style="display:flex;gap:10px;">
<button id="bgDarkBtn" class="bg-btn" style="flex:1">Dark</button>
<button id="bgLightBtn" class="bg-btn" style="flex:1">Light</button>
</div>
</div>
</div>

<div class="control-column">
<div class="controls-block" id="message-controls-block">
<h3>Username</h3>
<input id="username" value="test">
<h3>Message Text (max 300 chars)</h3>
<textarea id="message" rows="5" maxlength="300">Testowy komunikat.</textarea>
<h3>Twitch Channel for Emotes</h3>
<input id="channelInput" placeholder="Enter channel name">
<button id="loadChannelEmotesBtn">Load Emotes</button>
</div>
</div>

<div id="emotesSidebar">
<h3>Emotes</h3>
<div id="emotesGridContainer"></div>
</div>

</div>

<div class="bottom-preview-container">
<div id="preview"></div>
<button id="save-comment">Export PNG</button>
</div>

<script>
const usernameEl=document.getElementById('username');
const messageEl=document.getElementById('message');
const previewEl=document.getElementById('preview');
const emblemGrid=document.getElementById('emblemGrid');
const limitMessage=document.getElementById('limitMessage');
const bgDarkBtn=document.getElementById('bgDarkBtn');
const bgLightBtn=document.getElementById('bgLightBtn');
const colorSwatches=document.querySelectorAll('.color-swatch');
const saveCommentBtn=document.getElementById('save-comment');
const channelInput=document.getElementById('channelInput');
const loadChannelEmotesBtn=document.getElementById('loadChannelEmotesBtn');
const emotesGridContainer=document.getElementById('emotesGridContainer');

let badgesBase=[];
let activeBadges=[];
let activeBackground='dark';
let activeColor='#9147ff';
let globalEmotes=[];
let channelEmotes={};
let currentChannel='';
let emotesLoaded=false;

function uid(){return 'b'+Math.random().toString(36).slice(2,9);}

// ---- Emblems ----
async function initializeLocalEmblems(){
  const response=await fetch('emblems.json');
  const files=await response.json();
  badgesBase=files.map(src=>({id:uid(),data:src}));
  refreshEmblemGrid();
  render();
}
function refreshEmblemGrid(){
    emblemGrid.innerHTML='';
    limitMessage.textContent=`Emblems in base: ${badgesBase.length}`;
    badgesBase.forEach(b=>{
        const img=document.createElement('img');
        img.className='active-emblem-item';
        img.src=b.data;
        img.alt=b.id;
        if(activeBadges.some(a=>a.id===b.id)) img.classList.add('active');
        img.addEventListener('click',()=>{
            if(activeBadges.some(a=>a.id===b.id)) activeBadges=activeBadges.filter(a=>a.id!==b.id);
            else activeBadges.push(b);
            refreshEmblemGrid();
            render();
        });
        emblemGrid.appendChild(img);
    });
}

// ---- Colors & Background ----
usernameEl.addEventListener('input',render);
messageEl.addEventListener('input',()=>{ if(messageEl.value.length>300) messageEl.value=messageEl.value.slice(0,300); render(); });
bgDarkBtn.addEventListener('click',()=>updateBackground('dark'));
bgLightBtn.addEventListener('click',()=>updateBackground('light'));
colorSwatches.forEach(s=>{ s.addEventListener('click',()=>{ colorSwatches.forEach(c=>c.classList.remove('selected')); s.classList.add('selected'); activeColor=s.dataset.color; render(); }); });
function updateBackground(style){ activeBackground=style; bgDarkBtn.classList.toggle('selected',style==='dark'); bgLightBtn.classList.toggle('selected',style==='light'); render(); }

// ---- Export PNG ----
saveCommentBtn.addEventListener('click',async()=>{
    render();
    if(!previewEl.firstChild) return;
    const canvas=await html2canvas(previewEl.firstChild,{backgroundColor:null,scale:2});
    const data=canvas.toDataURL('image/png');
    const a=document.createElement('a');
    a.href=data;
    a.download='message.png';
    a.click();
});

// ---- Emotes ----
function escapeHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
async function loadGlobalEmotes(){ const res=await fetch('https://api.7tv.app/v2/emotes/global'); const data=await res.json(); globalEmotes=data.map(e=>({name:e.name,url:e.urls[0][1]})); }
async function loadChannelEmotes(channel){ if(!channel) return; try{ const res=await fetch(`https://api.7tv.app/v2/users/${channel}/emotes`); const data=await res.json(); channelEmotes[channel]=data.map(e=>({name:e.name,url:e.urls[0][1]})); }catch(e){ channelEmotes[channel]=[]; } }

loadChannelEmotesBtn.addEventListener('click', async()=>{
    currentChannel = channelInput.value.trim().toLowerCase();
    if(currentChannel){ await loadChannelEmotes(currentChannel); emotesLoaded=false; render(); emotesGridContainer.innerHTML=''; }
});

function renderEmotesGrid(){
    if(emotesLoaded) return;
    const allEmotes=[...globalEmotes];
    if(currentChannel && channelEmotes[currentChannel]) allEmotes.push(...channelEmotes[currentChannel]);
    emotesGridContainer.innerHTML='';
    allEmotes.forEach(e=>{
        const img=document.createElement('img');
        img.src=e.url; img.alt=e.name; img.className='chat-emote';
        img.addEventListener('click',()=>{ messageEl.value += ` ${e.name} `; if(messageEl.value.length>300) messageEl.value=messageEl.value.slice(0,300); render(); });
        emotesGridContainer.appendChild(img);
    });
    emotesLoaded=true;
}

function parseEmotes(message){
    let parsed=escapeHtml(message);
    const emotes=[...globalEmotes];
    if(currentChannel && channelEmotes[currentChannel]) emotes.push(...channelEmotes[currentChannel]);
    emotes.forEach(e=>{
        const regex=new RegExp(`\\b${e.name}\\b`,'g');
        parsed=parsed.replace(regex, `<img class="chat-emote" src="${e.url}" alt="${e.name}">`);
    });
    return parsed.replace(/\n/g,'<br>');
}

function render(){
    const name=escapeHtml(usernameEl.value||'test');
    let messageText=messageEl.value||'message';
    if(messageText.length>300) messageText=messageText.slice(0,300);
    messageEl.value=messageText;
    const parts=parseEmotes(messageText);
    const badgeHtml=activeBadges.map(b=>`<img class="badge" src="${b.data}">`).join('');
    const bgClass=activeBackground==='light'?'light-bg':'';
    previewEl.innerHTML=`<div class="chat-line ${bgClass}"><div class="badges">${badgeHtml}</div><span class="username" style="color:${activeColor}">${name}</span>: <span class="message">${parts}</span></div>`;
}

// ---- Init ----
initializeLocalEmblems();
loadGlobalEmotes();
updateBackground(activeBackground);
render();
renderEmotesGrid();
</script>
</body>
</html>
